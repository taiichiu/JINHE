# 晉鶴內部管理系統規格文件（spec.zh.md）

📁 本文件為完整功能規格說明，供 GPT Agent 與開發團隊參考。

---

## 🧱 系統架構與技術原則

- 全系統為 SPA，使用 React + Tailwind CSS
- Firebase Firestore 為單一資料來源（禁止僅依賴前端快取）
- 支援桌機（管理）、平板（櫃台）、手機（員工）
- 所有資料異動需記錄操作 log
- 所有 UI 狀態需處理 loading / error
- 權限需前後端同步驗證，使用 Firestore rules 強制控管

---

## 🔐 多角色權限設計（具擴充彈性）

本系統採用「角色/權限分離」架構：

- 每個使用者綁定一個「角色」
- 每個角色可自訂權限（permission list）

### 預設角色（可刪除或編輯）：
| 角色 ID | 預設名稱 | 權限簡述 |
|---------|----------|----------|
| administrator | 老闆 | 全權控制（不能刪除） |
| manager | 店長 | 預約與排班控制 |
| receptionist | 櫃台人員 | 客戶與預約建立 |
| employee | 員工 | 僅能查看個人班表與預約 |
| business_manager | 業務經理 | 僅能看報表與介紹人統計 |

### 🔧 老闆可執行的角色操作：

- ✅ 新增/命名角色（可自訂中文名）
- ✅ 編輯該角色的所有權限
- ✅ 設定登入策略（kick / allow）
- ✅ 刪除角色（若無使用者綁定）

系統防呆：
- 正在被使用的角色禁止刪除
- 權限變更立即套用
- 預設 `administrator` 為保護角色，不可刪除

### 📌 權限範例（擴充型）：

- `appointment:create`：建立預約
- `client:form_design`：設計自訂欄位
- `schedule:manage`：管理排班
- `report:read_referrer`：查看介紹人報表
- `settings:manage`：變更系統設定

---

## 📅 行事曆 + 排班 + 預約整合

### 📌 預約管理（Appointment）

- 行事曆預設顯示時間：**09:00 ~ 21:00**
- **每格時間間隔：15 分鐘**
- 預約資料需同步檢查：
  - 員工是否排班
  - 該時段是否已有其他預約

#### ✅ 防呆處理
- 若有衝突禁止送出，UI 顯示明確錯誤
- 未指派員工時可暫存，但送出時再次驗證

---

## 👥 客戶資料與欄位設計

- 老闆可新增、刪除、拖曳欄位
- 支援欄位型別：
  - 單行文字、Email、日期、下拉選單、單選、多選、checkbox、介紹人選擇（可指派內部業務）
- 客戶來源若為「介紹」，介紹人欄位為必填（選自內部使用者）

#### 🔁 資料儲存規則
- 拖曳後需一次儲存整包欄位，確保順序正確
- 欄位 `id` 唯一，排序過程中不可更動

---

## 🗓 員工排班（Schedule）

- 每位員工每日可排多段時段
- 排班儲存後，行事曆即時同步可用預約時段

#### 🔐 同步與防呆邏輯
- 排班過程 UI 需鎖定，避免建立預約時發生衝突
- 行事曆顯示與 Firestore 排班資料需雙向一致

---

## 🛎️ 報到與付款鎖定

- 客戶到店報到 → 點擊預約標示為「報到」
- 付款完成 → 加上 `locked: true`

#### 🔐 鎖定規範

- UI：
  - 所有按鈕自動 disable
- Firestore：
  - Rules 禁止修改/刪除已付款預約
- 錯誤需提示、紀錄 log、可備援自動重試

---

## 📊 營收與報表（Pie Chart + 明細）

- Pie Chart 僅顯示店長/員工服務貢獻金額
- 可點擊 Pie 各區塊查看明細
- **介紹人報表**：
  - 根據每位「介紹人」所帶來的客戶，統計當月所有消費金額
  - 若介紹人為內部業務帳號，視為該業務當月貢獻
- 禁止將同一筆消費重複加總在 Pie Chart + 介紹人報表中

### 📤 匯出功能

- 支援切換月份
- 匯出格式為 Excel，含明細欄（時間/服務/金額/介紹人等）

---

## ✅ 欄位驗證規則（跨平台一致）

| 欄位 | 驗證方式 |
|------|----------|
| 手機 | `/^09\d{8}$/` |
| Email | 標準格式 |
| 生日 | 日期選擇器 |
| 性別 | 下拉選單 |

- 使用 Yup / Zod + React Hook Form
- 所有驗證錯誤禁止送出 Firestore
- 行動裝置與桌機需一致驗證邏輯

---

## 🧠 GPT Agent 注意事項

- 行事曆僅顯示 09:00–21:00（不顯示凌晨時段）
- 預約時間以 15 分鐘為單位（quarter slot）
- 所有拖曳欄位需完整儲存順序與 id
- 預約前需確認班表 + 已有預約（防止衝突）
- 刪除資料後需同步刷新 UI（不可 stale）
- 付款完成後須全面鎖定（前端 + Firestore）
- 客戶來源為「介紹」時需指定介紹人（系統使用者）
- 所有關鍵操作請記錄操作 log

---

## 🧾 文件版本資訊

- 文件版本：v1.3
- 最後更新：2025-07-25
- 整合來源：jinheprompt.txt + 所有補強與用詞優化
